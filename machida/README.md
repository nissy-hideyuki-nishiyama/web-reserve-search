# 町田市の施設予約システムの仕様
## 利用者登録
- 身分証明書を提示して行う

## 抽選・予約・予約開放
- 抽選申込は一人で2件まで
- 抽選申し込み受付期間 : 施設利用を希望する日が属する月の2か月前の1日の8:00から10日の22:00まで
- 当選確定の受付期間 : 抽選月の月末まで
- 空き施設の予約申込 : 
    - 市内在住者: 利用する1か月前の8:30から先着順
    - 市外在住者: 利用する3週間前の8:30から先着順(1度申し込んで、キャンセルするとペナルティが発生してしまう期間)

## 予約
- 空き予約日の3週間前以降のキャンセルはペナルティが発生する
  - ペナルティは抽選申込と予約ができなくなる。
  - ただし、空き予約日の2週間前以降なら予約できる
- 市外在住者は空き予約日の3週間前以降しか予約できない
- 市外在住者は鶴間公園以外は予約できない

## 鶴間公園テニスコート
- 鶴間公園テニスコートは市外利用者も予約できる。他は予約できない
- 鶴間公園テニスコートの利用料は高い(平日￥3700、週末￥5000、他は一律￥1040)

## テニスコートの空き予約の検索
- 利用者IDでログインしなくてもできる
- 空き予約検索の最適な検索条件
  - 施設の分類 : スポーツ施設
  - 施設の種類 : テニスコート
  - 使用目的分類 : 屋外スポーツ
  - 使用目的 : テニス
  - 開始日 : 「検索日」
  - 検索期間 : 1日
  - 時間帯 : 全日
  - 曜日 : 指定しない
  - 施設 : テニスコート全部
- 上記の条件で、検索日のテニスコートの全施設、全時間帯の空き予約状況が表示される
- 検索対象期間の週末・祝日を1日ずつ、指定して実行する
- 1か月の週末・祝日が12回として、最大24回の検索が発生する。
    - 3か月先の月は全て申込受付中となるため、空き予約の対象外となる

## 機能概要
- cronジョブで起動される
- 非同期処理で空きコートを検索し、dict型リストに空きコートを登録する
  - 空きコート予約のdict型リストの構造
   ```bash
  { 
    date: {
        time: [
            court
        ]
    }
  }
  ```
  - 空きコート予約の検索が完了すると、所定のLINEグループに空きコート予約情報を通知する
- (未実装)上記のdict型リストを使って、予約処理を開始する
  - 空きコート予約リストが空(0件)の場合は予約処理を中止し、プログラムを終了する
  - コートの優先度を考慮して、空き予約リストから予約対象リストを生成する
  - 登録された利用者IDを使って予約処理を始める
  - 利用者IDの既存の予約済みリストと件数(全体件数と翌月土日件数)を取得し、予約上限数を超えている場合は次のIDで予約処理をする
  - 予約対象リストに従って、日付と時間で昇順に実施される
  - 予約ができた場合、所定のLINEグループに通知する

## 仕様
- 設定ファイル(cfg.json、ファイル名固定)でプログラムの定義する
- 祝日は祝日定義ファイル(public_holiday.json)で定義する
- スレッド処理の同時実行数(threads_num)を指定できる
- 空き予約コート検索において、次を設定できる
  - 検索対象日は曜日で指定する。月曜日(0)から日曜日(6)で、曜日コードで指定する
  - 個別に検索したい日は設定ファイルの"want_month_days"で指定する
  - 検索から除外する時間帯(9:00～11:00、19:00～21:00)を指定する
- (以下は未実装)予約処理において、次を設定できる
  - 予約したい時間帯(06:00～08:00、16:00～17:00)を指定する
  - 予約したいコート(鶴間公園テニスコート Ａ面)をフルネームで指定する。リストの順がコートの優先順位となる
  - 予約処理に使う利用者ID(複数可能)を指定する。利用者IDは次のタイプに分かれる
    - admin: 管理者(1つのみ)
    - inners: 市内在住者(複数可能)
    - outers: 市外居住者(複数可能)
    - 利用者IDは、admin, inner, outerの順で予約処理に利用される
  - 今日から〇日以降を予約したい場合、この〇日(days_later)を設定する。これはキャンセル料が発生する予約は取らないために作った
  - 予約開放日(open_day、町田市の場合は1日)を指定する。予約開放日によって挙動が変わる
    - 予約開放日前と以降では予約上限数と翌月土日予約上限数が変わる。それぞれ指定する
    - 予約開放日前はadminとinnersの利用者IDを使うが、以降は全てのIDを使う
  - 予約処理は日付と時間帯で昇順に実施される。1つのIDでは同日同時間帯では一つのコートのみ予約する
  - 次回の予約処理で残っている場合は他のコートを予約できる
  - 予約上限数、翌月予約上限数を超えた場合、その利用者IDでの予約処理を終了し、次の予約者IDで予約処理を継続する
  - 予約処理ができると1件毎に所定のLINEグループに予約完了を通知する

## 設定ファイル(cfg.json)の説明
### 設定ファイルのパラメータ説明
上から順に説明する
- top_url: プログラム内で参照される値なので原則さわらない
- first_url: 同上
- second_url: 同上
- third_url: 同上
- cookie: 同上
- exclude_courts: 空き予約コート検索から除外したい施設名(町田公園テニスコート)を記述する
- exclude_times: 空き予約コート検索から除外したい時間帯を指定する
- line_token: 通知先のLINEグループに参加しているLINE Notifyのトークンコードを指定する
- line_max_message_size: LINE Notifyの最大文字数(1000文字固定)を指定する
- threads_num: スレッド処理の同時実行数を指定する
- month_period: 空きコート予約検索の検索対象月期間を指定する。町田市は2か月先の2となる
- start_day: 次の予約期間が開始される日を指定する。町田市は毎月1日なので、1となる
- open_day: 予約開放日を指定する。町田市は毎月1日なので、1となる
- want_weekdays: 空きコート予約で検索したい曜日を指定する。月曜日(0)から日曜日(6)で、曜日コードで指定する
- want_month_days: 上記の空きコート予約で検索したい曜日および祝日以外で空きコート予約で検索したい日を指定する
- exclude_month_days: 予約検索処理から除外したい日を指定する。
- exclude_location: 予約処理から除外したいコートを指定する。空き予約コート検索はできるが、予約処理はしなくなる。
- days_later: プログラム起動日から〇日以降は予約処理対象とする〇日を指定する
- (以下は現時点では利用していない。将来の予約処理のために残す)
- reserved_limit: 予約上限数(予約開放日前)を指定する
- reserved_limit_after_open_day: 予約上限数(予約開放日以降)を指定する
- reserved_limit_for_next_month: 翌月土日予約上限数(予約開放日前)を指定する
- reserved_limit_for_next_month_after_open_day: 翌月土日予約上限数(予約開放日以降)を指定する
- reserved_limit_in_same_day: 同日予約できる上限数を指定する。多摩市は同日で2件まで。
- userauth: 予約処理に使う利用者IDとパスワードを指定する。admin(管理者), inner(市内在住者), outer(市外居住者)のタイプがある。ID:PASSWORDとなっている
- want_location_list: 予約したいコート名を指定する。優先順位の高いものから並べる
- want_hour_list: 予約したい時間帯を指定する。

### 設定ファイルのサンプル
```bash
{
    "top_url": "https://www.pf489.com/machida/",
    "first_url": "https://www.pf489.com/machida/dselect.html",
    "second_url": "https://www.pf489.com/machida/web/?Startpage=WpTopMenu",
    "third_url": "https://www.pf489.com/machida/web/Wp_TopMenu.aspx",
    "cookie": "",
    "exclude_courts": [
    ],
    "exclude_times": [
    ],
    "line_token": "abcdefghijklmnopqrstu",
    "line_max_message_size": 1000,
    "threads_num": 4,
    "logger_conf": {
      "logfile_path": "/var/log/webscribe/machida.log",
      "level_filehandler": "INFO",
      "level_consolehandler": "DEBUG",
      "logsize_maxbytes": 100000,
      "backup_count": 10
    },
    "month_period": 2,
    "start_day": 1,
    "open_day": 1,
    "want_weekdays": [ 5, 6 ],
    "want_month_days": {
        "1": [],
        "2": [],
        "3": [],
        "4": [],
        "5": [],
        "6": [],
        "7": [],
        "8": [],
        "9": [],
        "10": [],
        "11": [],
        "12": []
    },
    "exclude_month_days": {
        "1": [],
        "2": [],
        "3": [],
        "4": [],
        "5": [],
        "6": [],
        "7": [],
        "8": [],
        "9": [],
        "10": [],
        "11": [],
        "12": []
    },
    "exclude_location": [
    ],
    "days_later": 0,
    "reserved_limit": 15,
    "reserved_limit_after_open_day": 20,
    "reserved_limit_for_next_month": 2,
    "reserved_limit_for_next_month_after_open_day": 15,
    "reserved_limit_in_same_day": 2,
    "userauth": {
      "admin": {
        "admin": "admin_passwd"
      },
      "inners": {
        "inner01": "inner01_passwd",
        "inner02": "inner02_passwd"
      },
      "outers": {
        "outer01": "outer01_passwd",
        "outer02": "outer02_passwd"
      }
    },
    "want_location_list": [
    ],
    "want_hour_list": [
    ]
}

```

## 祝日定義ファイル(public_holiday.json)
祝日を定義する。1年に1回メンテナンスする必要がある。下記は2021年のサンプルとなる
```bash
{
    "1": [ 1, 11 ],
    "2": [ 11, 23 ],
    "3": [ 20 ],
    "4": [ 29 ],
    "5": [ 3, 4, 5 ],
    "6": [],
    "7": [ 22, 23 ],
    "8": [ 9 ],
    "9": [ 20, 23 ],
    "10": [],
    "11": [ 3, 23 ],
    "12": []
}
```
