# web-reserve-search for hachioji

# 八王子市施設予約検索と予約プログラム

## プログラムの目的
- 多摩市の施設予約でテニスコートの空きコートを探し通知する
- 登録している利用者IDを使って空きコートを予約する

## 機能概要
- cronジョブで起動される
- スレッド処理で空きコートを検索し、dict型リストに空きコートを登録する
  - 空きコート予約のdict型リストの構造
   ```bash
  { 
    date: {
        time: [
            court
        ]
    }
  }
  ```
  - 空きコート予約の検索が完了すると、所定のLINEグループに空きコート予約情報を通知する
- 上記のdict型リストを使って、予約処理を開始する
  - 空きコート予約リストが空(0件)の場合は予約処理を中止し、プログラムを終了する
  - コートの優先度を考慮して、空き予約リストから予約対象リストを生成する
  - 登録された利用者IDを使って予約処理を始める
  - 利用者IDの既存の予約済みリストと件数(全体件数と翌月土日件数)を取得し、予約上限数を超えている場合は次のIDで予約処理をする
  - 予約対象リストに従って、日付と時間で昇順に実施される
  - 予約ができた場合、所定のLINEグループに通知する
  - (八王子追加)
    - 利用者ID毎に空き予約リストから予約処理対象とする予約対象リストを生成する。これを使って予約処理を実施する
    - 利用者IDの既存の予約済みリストからその日の予約時間の最小値と最大値を計算し、予約対象の予約がその間にはない場合のみ予約処理をする

## 仕様
- 設定ファイル(cfg.json、ファイル名固定)でプログラムの定義する
- 祝日は祝日定義ファイル(public_holiday.json)で定義する
- 利用目的と利用目的コード、施設名と施設コード、コート名とコートコードを対応ファイル(menu_map.json)で定義する
- スレッド処理の同時実行数(threads_num)を指定できる
- 空き予約コート検索において、次を設定できる
  - 検索対象日は曜日で指定する。月曜日(0)から日曜日(6)で、曜日コードで指定する
  - 個別に検索したい日は設定ファイルの"want_month_days"で指定する
  - 検索から除外するコートをコートのコード("0040:00004")で指定する
  - 検索から除外する時間帯(06:00～08:00、16:00～17:00)を指定する
- 予約処理において、次を設定できる
  - 予約したい時間帯(06:00～08:00、16:00～17:00)を指定する
  - 予約したいコート(多摩東公園庭球場Ｄ（人工芝）)をフルネームで指定する。リストの順がコートの優先順位となる
  - 予約処理に使う利用者ID(複数可能)を指定する。利用者IDは次のタイプに分かれる
    - admin: 西山(1つのみ)
    - inners: 市内在住者(複数可能)
    - outers: 市外居住者(複数可能)
    - 利用者IDは、admin, inner, outerの順で予約処理に利用される
  - 今日から〇日以降を予約したい場合、この〇日(days_later)を設定する。これはキャンセル料が発生する予約は取らないために作った
  - 予約開放日(open_day、多摩市の場合は13日)を指定する。
  - 予約処理は日付と時間帯で昇順に実施される。1つのIDでは同日同時間帯では一つのコートのみ予約する
  - 次回の予約処理で残っている場合は他のコートを予約できる
  - 予約上限数、超えた場合、その利用者IDでの予約処理を終了し、次の予約者IDで予約処理を継続する
  - 予約処理ができると1件毎に所定のLINEグループに予約完了を通知する

## 設定ファイル(cfg.json)の説明
### 設定ファイルのパラメータ説明
上から順に説明する
- first_url: プログラム内で参照される値なので原則さわらない
- mypage_url: 同上
- calender_url: 同上
- cookie_sessionid: 同上
- cookie_utmz: 同上
- cookie_utmc: 同上
- cookie_utma: 同上
- exclude_want_month_days: 予約処理から除外したい日付を記述する。月毎のリスト形式で記述する
- exclude_month_days: 空き予約コート検索から除外したい日付を記述する。月毎のリスト形式で記述する
- exclude_courts: 空き予約コート検索から除外したいコート(一の宮公園)のコードを記述する。コードはコート名とコートのコードの対応ファイル(court_map.json)を参照のこと
- exclude_times: 空き予約コート検索から除外したい時間帯を指定する
- line_token: 通知先のLINEグループに参加しているLINE Notifyのトークンコードを指定する
- line_max_message_size: LINE Notifyの最大文字数(1000文字固定)を指定する
- threads_num: 並列処理の同時実行数を指定する
- logger_conf: アプリケーションログの設定
  - logfile_path: ログファイルのパスを指定する
  - level_filehandler: ログファイルに記録するログレベルを指定する
  - level_consolehandler: コンソールに出力するログレベルを指定する。主に手動で実行してデバッグするときに利用する
  - logsize_maxbytes: ログファイルの最大サイズを指定する。超えると新しいログファイルに切り替えられる
  - backup_count: ログファイルのバックアップ世代数を指定する。超えると古いログファイルから削除される
- month_period: 空きコート予約検索の検索対象月期間を指定する。八王子市は2か月先の2となる
- start_day: 次の予約期間が開始される日を指定する。八王子市は毎月7日なので、7となる
- open_day: 予約開放日を指定する。八王子市は毎月16日なので、16となる
- want_weekdays: 空きコート予約で検索したい曜日を指定する。月曜日(0)から日曜日(6)で、曜日コードで指定する
- want_month_days: 上記の空きコート予約で検索したい曜日および祝日以外で空きコート予約で検索したい日を指定する
- days_later: プログラム起動日から〇日以降は予約処理対象とする〇日を指定する
- reserved_limit: 予約上限数(予約開放日前)を指定する
- reserved_limit_after_open_day: 予約上限数(予約開放日以降)を指定する
- reserved_limit_for_next_month: 翌月土日予約上限数(予約開放日前)を指定する
- reserved_limit_for_next_month_after_open_day: 翌月土日予約上限数(予約開放日以降)を指定する
- reserved_limit_in_same_day: 同日予約できる上限数を指定する。八王子市は同日で2件まで。
- whole_reserved_limit_at_onetime: 1回の空き予約検索・予約処理で予約できる全体の件数を指定する。多すぎると目を付けられる
- user_reserved_limit_at_onetime: 1回の空き予約検索・予約処理でユーザー毎に予約できる件数を指定する。多すぎると目を付けられる
- userauth: 予約処理に使う利用者IDとパスワードを指定する。admin(管理者), inner(市内在住者), outer(市外居住者)のタイプがある。ID:PASSWORDとなっている
- want_location_list: 予約したいコート名を指定する。優先順位の高いものから並べる
- want_hour_list: 予約したい時間帯を指定する。


### 設定ファイルのサンプル
```bash
{
  "first_url": "https://shisetsu.city.hachioji.tokyo.jp/",
  "mypage_url": "https://shisetsu.city.hachioji.tokyo.jp/mypage/",
  "calender_url": "https://shisetsu.city.hachioji.tokyo.jp/reserve/calendar",
  "cookie_sessionid": "PHPSESSID",
  "cookie_utmz": "__utmz",
  "cookie_utmc": "__utmc",
  "cookie_utma": "__utma",
  "institution_list": {
  },
  "exclude_want_month_days": {
      "1": [ 1, 2, 3 ],
      "2": [],
      "3": [],
      "4": [],
      "5": [],
      "6": [],
      "7": [],
      "8": [ ],
      "9": [ ],
      "10": [],
      "11": [],
      "12": [ 31 ]
  },
  "exclude_month_days": {
    "1": [],
    "2": [],
    "3": [],
    "4": [],
    "5": [],
    "6": [],
    "7": [],
    "8": [],
    "9": [],
    "10": [],
    "11": [],
    "12": []
  },
  "exclude_times": [
    "18:00～20:00",
    "20:00～22:00"
  ],
  "exclude_courts": [
    "富士森公園",
    "久保山公園",
    "殿入中央公園",
    "椚田運動場",
    "戸吹スポーツ公園"
  ],
  "line_token": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  "line_max_message_size": 1000,
  "threads_num": 4,
  "logger_conf": {
    "logfile_path": "/var/log/webscribe/hachioji.log",
    "level_filehandler": "INFO",
    "level_consolehandler": "DEBUG",
    "logsize_maxbytes": 100000,
    "backup_count": 10
  },
  "month_period": 2,
  "start_day": 7,
  "open_day": 13,
  "want_weekdays": [ 0 ],
  "want_month_days": {
      "1": [],
      "2": [],
      "3": [],
      "4": [],
      "5": [],
      "6": [],
      "7": [],
      "8": [],
      "9": [],
      "10": [],
      "11": [],
      "12": []
  },
  "days_later": 7,
  "reserved_limit": 6,
  "whole_reserved_limit_at_onetime": 15,
  "user_reserved_limit_at_onetime": 3,
  "userauth": {
    "admin": {
      "123456789": {
        "password": "1234",
        "securityid": ""
      }
    },
    "inners": {
    },
    "outers": {
    }
  },
  "want_location_list": [
    "大塚公園 テニスコートＡ面",
    "大塚公園 テニスコートＢ面",
    "大塚公園 テニスコートＣ面",
    "大塚公園 テニスコートＤ面",
    "別所公園 テニスコートＡ面",
    "別所公園 テニスコートＢ面",
    "上柚木公園 テニスコートＡ面",
    "上柚木公園 テニスコートＢ面",
    "上柚木公園 テニスコートＣ面",
    "上柚木公園 テニスコートＤ面",
    "上柚木公園 テニスコートＥ面",
    "上柚木公園 テニスコートＦ面",
    "上柚木公園 テニスコートＧ面",
    "上柚木公園 テニスコートＨ面",
    "松木公園 テニスコートＡ面",
    "松木公園 テニスコートＢ面",
    "松木公園 テニスコートＣ面",
    "松木公園 テニスコートＤ面",
    "松木公園 テニスコートＥ面",
    "松木公園 テニスコートＦ面",
    "松木公園 テニスコートＧ面",
    "松木公園 テニスコートＨ面",
    "松木公園 テニスコートＩ面",
    "松木公園 テニスコートＪ面",
    "大平公園 テニスコートＡ面",
    "大平公園 テニスコートＢ面",
    "滝ガ原運動場 テニスコート（ハード）１面",
    "滝ガ原運動場 テニスコート（ハード）２面",
    "滝ガ原運動場 テニスコート（ハード）３面",
    "滝ガ原運動場 テニスコート（ハード）４面",
    "滝ガ原運動場 テニスコート（クレー）１面",
    "滝ガ原運動場 テニスコート（クレー）２面",
    "滝ガ原運動場 テニスコート（クレー）３面",
    "滝ガ原運動場 テニスコート（クレー）４面"
  ],
  "want_hour_list": [
    "08:30～10:30",
    "10:30～12:30",
    "12:30～14:30",
    "14:30～16:30",
    "16:30～18:30",
    "09:30～11:30",
    "11:40～13:40",
    "13:50～15:50",
    "08:45～10:45",
    "10:45～12:45",
    "12:45～14:45",
    "14:45～16:45",
    "08:00～10:00",
    "10:00～12:00",
    "12:00～14:00",
    "14:00～16:00",
    "16:00～18:00"
  ]
}

```

## 祝日定義ファイル(public_holiday.json)
祝日を定義する。1年に1回メンテナンスする必要がある。下記は2021年のサンプルとなる
```bash
{
    "1": [ 10 ],
    "2": [ 11, 23 ],
    "3": [ 21 ],
    "4": [ 29 ],
    "5": [ 3, 4, 5 ],
    "6": [],
    "7": [ 18 ],
    "8": [ 11 ],
    "9": [ 19, 23 ],
    "10": [ 10 ],
    "11": [ 3, 23 ],
    "12": []
}
```
## 利用目的と利用目的コード、施設名と施設コード、コート名とコートコードを対応ファイル(menu_map.json)
利用目的と利用目的コード、施設名と施設コード、コート名とコートコードを対応ファイル(menu_map.json)で定義する。新しいコートや廃止されたコートがあった場合メンテナンスする
```bash
{
    "class": {
        "体育館": 1,
        "テニスコート": 2,
        "野球・ソフトボール場": 3,
        "サッカー・ラグビー場": 4
    },
    "facility_id": {
        "冨士森公園": 10,
        "上柚木公園": 13,
        "大塚公園": 15,
        "松木公園": 16,
        "大平公園": 17,
        "別所公園": 18,
        "内裏谷戸公園": 19,
        "久保山公園": 20,
        "殿入中央公園": 21,
        "戸吹スポーツ公園": 22,
        "椚田運動場": 30,
        "滝ガ原運動場": 32
    },
    "field_group_id": {
        "冨士森公園": {
            "テニスコートＡ面": 101020,
            "テニスコートＢ面": 101030,
            "テニスコートＣ面": 101040,
            "テニスコートＤ面": 101050,
            "テニスコートＥ面": 101060,
            "テニスコートＦ面": 2107801
        },
        "上柚木公園": {
            "テニスコートＡ面": 131340,
            "テニスコートＢ面": 131350,
            "テニスコートＣ面": 131360,
            "テニスコートＤ面": 131370,
            "テニスコートＥ面": 131380,
            "テニスコートＦ面": 131390,
            "テニスコートＧ面": 131400,
            "テニスコートＨ面": 131410
        },
        "大塚公園": {
            "テニスコートＡ面": 151520,
            "テニスコートＢ面": 151530,
            "テニスコートＣ面": 151540,
            "テニスコートＤ面": 151550
        },
        "松木公園": {
            "テニスコートＡ面": 161610,
            "テニスコートＢ面": 161620,
            "テニスコートＣ面": 161630,
            "テニスコートＤ面": 161640,
            "テニスコートＥ面": 161650,
            "テニスコートＦ面": 161660,
            "テニスコートＧ面": 161670,
            "テニスコートＨ面": 161680,
            "テニスコートＩ面": 161690,
            "テニスコートＪ面": 161700
        },
        "大平公園": {
            "テニスコートＡ面": 171710,
            "テニスコートＢ面": 171720
        },
        "別所公園": {
            "テニスコートＡ面": 181810,
            "テニスコートＢ面": 181820
        },
        "内裏谷戸公園": {
            "テニスコートＡ面": 191910,
            "テニスコートＢ面": 191920
        },
        "久保山公園": {
            "テニスコートＡ面": 202010,
            "テニスコートＢ面": 202020
        },
        "殿入中央公園": {
            "テニスコートＡ面": 212110,
            "テニスコートＢ面": 212120
        },
        "戸吹スポーツ公園": {
            "テニスコートＡ面": 222210,
            "テニスコートＢ面": 222220,
            "テニスコートＣ面": 222230,
            "テニスコートＤ面": 222240,
            "テニスコートＥ面": 222250,
            "テニスコートＦ面": 222260
        },
        "椚田運動場": {
            "テニスコートＡ面": 303010,
            "テニスコートＢ面": 303020,
            "テニスコートＣ面": 303030
        },
        "滝ガ原運動場": {
            "テニスコート（ハード）１面": 323320,
            "テニスコート（ハード）２面": 323330,
            "テニスコート（ハード）３面": 323340,
            "テニスコート（ハード）４面": 323350,
            "テニスコート（クレー）１面": 323360,
            "テニスコート（クレー）２面": 323370,
            "テニスコート（クレー）３面": 323380,
            "テニスコート（クレー）４面": 323390
        }
    }
}
```